#' @title Infer sample-specific hypermethylation
#' @description Expected DHcR was estimated through beta-regression first. Next, expected DHcR was tested
#'     against to observed DHcR to evalute if there was promoter hypermethylation.
#' @param formula An object of class "formula" (or one that can be coerced to that class):
#'     a symbolic description of the model to be fitted. The name of y variable must DHcR_Tumor_Beta.
#' @param data A data frame object generated by makeInputMatrix function (input matrix).
#'     The object contains following columns:
#'     Id, Hugo, Covariates included in matCV, PDR_Tumor, Depth_Tumor, CpGs_Tumor and DHcR_Tumor.
#' @return A data frame summarizing information of sample-specific hypermethylation inference. Addtional columns
#'     were added to input matrix.
#'     \itemize{
#'       \item DHcR_Tumor_Beta: Transformed data of DHcR_Tumor (from [0, 1] to (0, 1))
#'       \item Beta_Response: Response value from beta-regression
#'       \item Beta_Precision: Precisison value from beta-regression
#'       \item Pvalue: P-value of sample-specific hypermethylation inference
#'     }
#' @examples
#' pvalueBetaReg('DHcR_Tumor_Beta~DHcR_Normal+PDR_Normal+GEXP_Normal+Reptime+PDR_Tumor+Depth_Tumor+CpGs_Tumor',
#'     inputMat)
#'
pvalueBetaReg <- function(formula, data) {
  # data transformation from [0,1] to (0,1)
  scale.factor <- round(nrow(data)/length(unique(data$Id)))
  data$DHcR_Tumor_Beta <- (data$DHcR_Tumor*(scale.factor-1)+0.5)/scale.factor

  # fit beta regression model
  fit.beta <- betareg::betareg(formula, data=data)

  # estimate expected hypermethylation of tumor samples
  data$Beta_Response <- predict(fit.beta, data=data, type='response') # mu
  data$Beta_Precision <- predict(fit.beta, data=data, type='precision') # phi
  shape1 <- data$Beta_Response * data$Beta_Precision
  shape2 <- data$Beta_Precision - shape1
  ans <- data.frame(beta=data$DHcR_Tumor_Beta, shape1=shape1, shape2=shape2)

  # evaluate if observed DHcR is significantly higher than expected DHcR
  data$Pvalue <- apply(ans, 1, function(x) pbeta(as.numeric(x[1]), as.numeric(x[2]), as.numeric(x[3]), lower.tail=F))
  return(data)
}
