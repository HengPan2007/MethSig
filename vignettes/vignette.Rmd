---
title: "Introduction to the MethSig pacakge"
author: "Heng Pan"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


```{r setup}
library(MethSig)
```

## Introduction
MethSig is used to used to infer DNA methylation drivers from bisulfite converted data of cancer cohort.

## Setup
```{r eval = F}
install.packages("devtools")
devtools::install_github("HengPan2007/MethSig")
```

## Prerequisite

### 1. Data alignment and processing.
Bisulfite converted data were aligned and processed as described in our published book chapter (Pan et al., Cancer Systems Biology, 2018)

### 2. Preparation of covariate matrix.
A matrix of covariates, which are included into the beta-regression model, is needed. The matrix must include a column of Hugo gene symbol and at least one column of covariate. An example can be loaded by invisible(matCV).

```c
matCV <- invisible(matCV)
```
This example matrix includes Hugo symbol (Hugo), average promoter DHcR levels in control samples (DHcR_Normal), average promoter PDR levels in control samples (PDR_Normal), average gene expression levels in control samples (GEXP_Normal) and DNA replication time (Reptime). Users can include as many as covariates they want.

```{r, echo=F}
head(matCV)
```

### 3. Files containing information of hypermethylated cytosine (HCs).
A tab-separated values input file. The input file contains details of differentially methylated cytosines with following columns (V1 to V11): chr, pos, numC in control, numC+numT in control, numC in tumor, numC + numT in tumor, CpG methylation ratio (tumor methylation / control methylation), chi-squared p-value, adjusted p-value, significance, hyper or hypo in tumor. Details of generating this type of files were described in Pan et al, Cancer Systems Biology, 2018. An example file can be found in extdata/DMC.SRR2069925.txt. Notably, the name needs to be in DMC.Sample_name.txt format.

```{r, echo=F}
tmp <- read.table('~/MethSig/inst/extdata/DMC.SRR2069925.txt', header=F, sep='\t')
head(tmp)
```

### 4. Files containing information of proportion of discordant reads (PDR) at CpGs 
A tab-separated values input file. The input file contains PDR of single CpG with following columns: chr, start, strand, ConMethReadCount, ConUMethReadCount, DisReadCount, NAReadCount. Details of PDR were described in Landau et al., Cancer Cell, 2014. extdata/pdrCall_from_Bismark.py can be used to call PDR of single CpG from Bismark outputs (files starting with CpG_OB or CpG OT). An example file can be found in extdata/PDR.SRR2069925.txt. Notably, the name needs to be in PDR.sample_name.txt format.

```{r, echo=F}
tmp <- read.table('~/MethSig/inst/extdata/PDR.SRR2069925.txt', header=T, sep='\t')
head(tmp)
```

## Make input matrix

### 1. Calculate promoter DHcR
Promoter (defined as Â± 2kb windows centered on Refseq transcription start site) hypermethylation was measured using differentially hypermethylated cytosine ratio (DHcR), defined as the ratio of hypermethylated cytosines (HCs) to the total number of promoter CpGs profiled. HCs of each sample were defined as CpGs at which DNAme is statistically higher than the average DNAme of control samples (false discovery rate=20%, Chi-squared test). Only CpGs with read depth greater than 10 reads were included in the analysis. RRBS data of matched normal tissues were used as control samples. An implemented function makeHG19Promoters was used to provide promoter annotations of hg19 refSeq genes. Users and use their own annotations instead.

```{r}
dhcr <- promoterDHcR(file_name = '~/MethSig/inst/extdata/DMC.SRR2069925.txt', pro = makeHG19Promoters())
head(dhcr)
```

### 2. Calculate promoter PDR
If all the CpGs on a specific read are methylated, or all of the CpGs on a read are unmethylated, the read is classified as concordant; otherwise it is classified as discordant. At each CpG, the PDR is equal to the number of discordant reads that cover that location divided by the total number of read that cover that location. The PDR of promoter is given by averaging the values of individual CpGs, as calculated for all CpGs within the promoter of interest with read depth greater than 10 reads and that are covered by reads that contain at least 4 CpGs.

```{r}
pdr <- promoterPDR(file_name = '~/MethSig/inst/extdata/PDR.SRR2069925.txt', pro = makeHG19Promoters())
head(pdr)
```

### 3. Make input matrix
As mentioned in Prerequisite section, users need to store DMC.Sample_name.txt and PDR.Sample_name.txt files in the input_dir folder. Also, a user defined covarites matrix is needed.
```{r}
ds <- makeInputMatrix(names_list=as.list(c("SRR2069925")), matCV = invisible(matCV), 
                      pro = makeHG19Promoters(), input_dir = '~/MethSig/inst/extdata/')
head(ds)
```

### Patient-specific hypermethylation inference
Expected promoter DHcR of tumor samples was estimated by beta-regression model and expected DHcR was tested against observed DHcR to infer hypermethylation status.
```{r}
pval <- pvalueBetaReg(formula = as.formula('DHcR_Tumor_Beta~DHcR_Normal+PDR_Normal+GEXP_Normal+Reptime+PDR_Tumor+Depth_Tumor+CpGs_Tumor'),
                      data = invisible(inputMat))
head(pval)
```

### Cohort-prevalent hypermethylation inference
Wilkinson p-value combination method was used to determine if promoter hypermethylation is over-represented in the cohort.
```{r}
pval <- pvalueCombine(data = invisible(pvalByGenePt), K = 10, times = 100, r = 2)
head(pval)
```
